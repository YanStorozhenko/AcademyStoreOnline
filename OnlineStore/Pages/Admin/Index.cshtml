
@page
@model OnlineStore.Pages.Admin.IndexModel
@using OnlineStore.Extensions
@{
    ViewData["Title"] = "Панель администратора";
}

<div class="container-fluid">
    <div class="row">
        <!-- Боковая панель админа -->
        <nav class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse">
            <div class="position-sticky pt-3">
                <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-white">
                    <span>Администрирование</span>
                </h6>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link text-white @(Model.ActiveSection == "dashboard" ? "active" : "")" 
                           href="?section=dashboard">
                            <i class="bi bi-speedometer2 me-2"></i> Дашборд
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white @(Model.ActiveSection == "products" ? "active" : "")" 
                           href="?section=products">
                            <i class="bi bi-box me-2"></i> Товары
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white @(Model.ActiveSection == "categories" ? "active" : "")" 
                           href="?section=categories">
                            <i class="bi bi-tags me-2"></i> Категории
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white @(Model.ActiveSection == "orders" ? "active" : "")" 
                           href="?section=orders">
                            <i class="bi bi-cart-check me-2"></i> Заказы
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white @(Model.ActiveSection == "users" ? "active" : "")" 
                           href="?section=users">
                            <i class="bi bi-people me-2"></i> Пользователи
                        </a>
                    </li>
                </ul>
                
                <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-white">
                    <span>Быстрые действия</span>
                </h6>
                <ul class="nav flex-column mb-2">
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/Admin/Products/Create">
                            <i class="bi bi-plus-circle me-2"></i> Добавить товар
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/Catalog">
                            <i class="bi bi-shop me-2"></i> Перейти в магазин
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
        
        <!-- Основной контент -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <!-- Заголовок -->
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Панель администратора</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group me-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-download"></i> Экспорт
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Дашборд -->
            @if (Model.ActiveSection == "dashboard")
            {
                <div class="row">
                    <!-- Карточки статистики -->
                    <div class="col-md-3 mb-4">
                        <div class="card border-primary">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="card-subtitle mb-2 text-muted">Всего товаров</h6>
                                        <h4 class="card-title">@Model.TotalProducts</h4>
                                    </div>
                                    <i class="bi bi-box display-6 text-primary"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-4">
                        <div class="card border-success">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="card-subtitle mb-2 text-muted">Всего заказов</h6>
                                        <h4 class="card-title">@Model.TotalOrders</h4>
                                    </div>
                                    <i class="bi bi-cart-check display-6 text-success"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-4">
                        <div class="card border-info">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="card-subtitle mb-2 text-muted">Пользователи</h6>
                                        <h4 class="card-title">@Model.TotalUsers</h4>
                                    </div>
                                    <i class="bi bi-people display-6 text-info"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-4">
                        <div class="card border-warning">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="card-subtitle mb-2 text-muted">Общий доход</h6>
                                        <h4 class="card-title">@Model.TotalRevenue.ToString("C")</h4>
                                    </div>
                                    <i class="bi bi-currency-dollar display-6 text-warning"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Последние заказы -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Последние заказы</h5>
                            </div>
                            <div class="card-body">
                                @if (Model.RecentOrders.Any())
                                {
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>№ Заказа</th>
                                                    <th>Пользователь</th>
                                                    <th>Дата</th>
                                                    <th>Сумма</th>
                                                    <th>Статус</th>
                                                    <th>Действия</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var order in Model.RecentOrders)
                                                {
                                                    <tr>
                                                        <td>#@order.Id</td>
                                                        <td>@order.UserId</td>
                                                        <td>@order.OrderDate.ToString("dd.MM.yyyy HH:mm")</td>
                                                        <td>@order.TotalAmount.ToString("C")</td>
                                                        <td>
                                                            <span class="badge bg-@(order.Status == "Оплачен" ? "success" : "warning")">
                                                                @order.Status
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <a href="/Admin/Orders/Details/@order.Id" class="btn btn-sm btn-outline-primary">
                                                                <i class="bi bi-eye"></i>
                                                            </a>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                                else
                                {
                                    <p class="text-muted">Нет заказов</p>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
            
            <!-- Управление товарами -->
            @if (Model.ActiveSection == "products")
            {
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Управление товарами</h5>
                        <a href="/Admin/Products/Create" class="btn btn-primary btn-sm">
                            <i class="bi bi-plus-circle me-1"></i> Добавить товар
                        </a>
                    </div>
                    <div class="card-body">
                        @if (Model.Products.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Изображение</th>
                                            <th>Название</th>
                                            <th>Категория</th>
                                            <th>Цена</th>
                                            <th>Остаток</th>
                                            <th>Статус</th>
                                            <th>Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var product in Model.Products)
                                        {
                                            <tr>
                                                <td>@product.Id</td>
                                                <td>
                                                    <img src="@product.ImageUrl" 
                                                         alt="@product.Name" 
                                                         style="width: 50px; height: 50px; object-fit: cover;">
                                                </td>
                                                <td>
                                                    <strong>@product.Name</strong><br>
                                                    <small class="text-muted">
                                                        @{
                                                                var description = product.Description ?? "";
                                                                var truncated = description.Length > 50 
                                                                    ? description.Substring(0, 50) + "..." 
                                                                    : description; 
                                                            }
                                                            @truncated
                                                        </small>
                                                </td>
                                                <td>@product.Category?.Name</td>
                                                <td>@product.Price.ToString("C")</td>
                                                <td>
                                                    <span class="badge bg-@(product.Stock > 0 ? "success" : "danger")">
                                                        @product.Stock
                                                    </span>
                                                </td>
                                                <td>
                                                    @if (product.Stock > 0)
                                                    {
                                                        <span class="badge bg-success">В наличии</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-danger">Нет в наличии</span>
                                                    }
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <a href="/Admin/Products/Edit/@product.Id" 
                                                           class="btn btn-outline-primary">
                                                            <i class="bi bi-pencil"></i>
                                                        </a>
                                                        <form method="post" asp-page-handler="DeleteProduct" 
                                                              onsubmit="return confirm('Удалить товар?')" 
                                                              class="d-inline">
                                                            <input type="hidden" name="id" value="@product.Id" />
                                                            <button type="submit" class="btn btn-outline-danger">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted">Товары не найдены</p>
                        }
                    </div>
                </div>
            }
            
            <!-- Управление категориями -->
            @if (Model.ActiveSection == "categories")
            {
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Список категорий</h5>
                            </div>
                            <div class="card-body">
                                @if (Model.Categories.Any())
                                {
                                    <div class="list-group">
                                        @foreach (var category in Model.Categories)
                                        {
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>@category.Name</strong>
                                                    <small class="text-muted d-block">
                                                        @category.Products.Count товаров
                                                    </small>
                                                </div>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" 
                                                            onclick="editCategory(@category.Id, '@category.Name')">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <form method="post" asp-page-handler="DeleteCategory"
                                                          onsubmit="return confirm('Удалить категорию?')">
                                                        <input type="hidden" name="id" value="@category.Id" />
                                                        <button type="submit" class="btn btn-outline-danger">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <p class="text-muted">Категории не найдены</p>
                                }
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">@(Model.EditingCategoryId.HasValue ? "Редактировать" : "Добавить") категорию</h5>
                            </div>
                            <div class="card-body">
                                <form method="post" asp-page-handler="SaveCategory">
                                    <input type="hidden" name="id" value="@Model.EditingCategoryId" />
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Название категории</label>
                                        <input type="text" class="form-control" 
                                               name="name" 
                                               value="@Model.EditingCategoryName"
                                               required>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between">
                                        <button type="submit" class="btn btn-primary">
                                            @(Model.EditingCategoryId.HasValue ? "Сохранить" : "Добавить")
                                        </button>
                                        
                                        @if (Model.EditingCategoryId.HasValue)
                                        {
                                            <a href="?section=categories" class="btn btn-outline-secondary">
                                                Отмена
                                            </a>
                                        }
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            }
            
            <!-- Управление заказами -->
            @if (Model.ActiveSection == "orders")
            {
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Управление заказами</h5>
                    </div>
                    <div class="card-body">
                        @if (Model.AllOrders.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>№ Заказа</th>
                                            <th>Пользователь</th>
                                            <th>Дата</th>
                                            <th>Товары</th>
                                            <th>Сумма</th>
                                            <th>Статус</th>
                                            <th>Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var order in Model.AllOrders)
                                        {
                                            <tr>
                                                <td>#@order.Id</td>
                                                <td>
                                                    <small>@order.UserId</small>
                                                </td>
                                                <td>@order.OrderDate.ToString("dd.MM.yyyy HH:mm")</td>
                                                <td>@order.Items.Count шт.</td>
                                                <td>@order.TotalAmount.ToString("C")</td>
                                                <td>
                                                    <form method="post" asp-page-handler="UpdateOrderStatus" 
                                                          class="d-inline">
                                                        <input type="hidden" name="orderId" value="@order.Id" />
                                                        <select name="status" 
                                                                class="form-select form-select-sm" 
                                                                onchange="this.form.submit()">
                                                            <option value="Ожидает оплаты" 
                                                                    selected="@(order.Status == "Ожидает оплаты")">
                                                                Ожидает оплаты
                                                            </option>
                                                            <option value="Оплачен" 
                                                                    selected="@(order.Status == "Оплачен")">
                                                                Оплачен
                                                            </option>
                                                            <option value="В обработке" 
                                                                    selected="@(order.Status == "В обработке")">
                                                                В обработке
                                                            </option>
                                                            <option value="Отправлен" 
                                                                    selected="@(order.Status == "Отправлен")">
                                                                Отправлен
                                                            </option>
                                                            <option value="Доставлен" 
                                                                    selected="@(order.Status == "Доставлен")">
                                                                Доставлен
                                                            </option>
                                                            <option value="Отменен" 
                                                                    selected="@(order.Status == "Отменен")">
                                                                Отменен
                                                            </option>
                                                        </select>
                                                    </form>
                                                </td>
                                                <td>
                                                    <a href="/Admin/Orders/Details/@order.Id" 
                                                       class="btn btn-sm btn-outline-primary">
                                                        <i class="bi bi-eye"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted">Заказы не найдены</p>
                        }
                    </div>
                </div>
            }
            
            <!-- Управление пользователями -->
            @if (Model.ActiveSection == "users")
            {
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Управление пользователями</h5>
                    </div>
                    <div class="card-body">
                        @if (Model.Users.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Email</th>
                                            <th>Роль</th>
                                            <th>Дата регистрации</th>
                                            <th>Заказов</th>
                                            <th>Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var user in Model.Users)
                                        {
                                            <tr>
                                                <td>@user.Email</td>
                                                <td>
                                                    <span class="badge bg-@(user.Role == "Admin" ? "danger" : "primary")">
                                                        @user.Role
                                                    </span>
                                                </td>
                                                <td>@user.RegistrationDate.ToString("dd.MM.yyyy")</td>
                                                <td>@user.OrderCount</td>
                                                <td>
                                                    @if (user.Role != "Admin")
                                                    {
                                                        <form method="post" asp-page-handler="ToggleAdmin" 
                                                              class="d-inline">
                                                            <input type="hidden" name="userId" value="@user.Id" />
                                                            <button type="submit" class="btn btn-sm btn-outline-warning">
                                                                Сделать админом
                                                            </button>
                                                        </form>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted">Пользователи не найдены</p>
                        }
                    </div>
                </div>
            }
        </main>
    </div>
</div>

<style>
    .sidebar {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        z-index: 100;
        padding: 48px 0 0;
        box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
    }
    
    .sidebar .nav-link {
        font-weight: 500;
        color: #adb5bd;
        padding: 0.5rem 1rem;
    }
    
    .sidebar .nav-link.active {
        color: #fff;
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .sidebar .nav-link:hover {
        color: #fff;
        background-color: rgba(255, 255, 255, 0.05);
    }
    
    .sidebar-heading {
        font-size: .75rem;
        text-transform: uppercase;
    }
</style>

<script>
    function editCategory(id, name) {
        window.location.href = `?section=categories&edit=${id}&name=${encodeURIComponent(name)}`;
    }
</script>